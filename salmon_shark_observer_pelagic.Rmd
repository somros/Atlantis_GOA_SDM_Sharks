---
title: "Observer data for salmon shark distributions"
author: "Alberto Rovellini"
date: "10/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(rbgm)
library(sf)
library(viridis)
library(maps)
library(mapdata)
library(data.table)
```

```{r}
select <- dplyr::select
```

This document explores observer data from [AKFIN](https://akfinbi.psmfc.org/analytics/saw.dll?Dashboard). The data is called [NORPAC Catch Report](https://akfinbi.psmfc.org/analytics/saw.dll?Dashboard&PortalPath=%2fshared%2fStock%20Assessment%2f_portal%2fStock%20Assessment&Page=NORPAC%20Catch%20Report&Done=Dashboard%26PortalPath%3d%252fshared%252fStock%2520Assessment%252f_portal%252fStock%2520Assessment%26Page%3dObserver%2520and%2520EM%2520Data%26ViewState%3dt8rvrc7c2svggcggmbmq9ce062). Here are the Report Criteria:

* Year: 1989-2019 (in smaller chunks)
* FMP Area: GOA
* FMP Subarea: --Select Value--
* NMFS Area: --Select Value--
* Gear Code: --Select Value--
* Gear Description: --Select Value--
* Performance: --Select Value--
* Performance Description: --Select Value--
* Species Code: --Select Value--
* Species Name: --Select Value--

There seem to be some issues with AKFIN not picking the correct years that we select. Let's use distinct(). Also, finding any metadata for this data set seems impossible - ask someone.

Read data.
```{r}
all_files <- list.files('../../../Catch_data/data/AKFIN/Observer/',full.names = TRUE) # get this from the observer data
obs_list <- lapply(all_files, read.csv, skip=6)

obs <- rbindlist(obs_list)

# distinct rows
obs <- obs %>% distinct()
glimpse(obs)
```

It appears that the extrapolated weight is the weight of this species in the haul, estimated from the sample taken from the haul. That is, an approximation of the catch in the haul.

## Salmon shark

Salmon sharks seem to get caught most often with pelagic trawl gear, occasionally with longline gear, rarely with bottom trawl and almost never by any other gear.

Let's keep only pelagic trawl gear, extract salmon shark catches, keep hauls that had no salmon sharks, and map it. We will need to obtain some form of CPUE, even just dividing by minuted of operation for each tow (probably not a great measure).

What do we do with haul performance? We may keep only hauls that were reported as having no problems. At the same time, they seem to keep fishing quite often if the haul had a problem.
```{r}
pelagic <- obs %>% filter(Gear.Description=='PELAGIC')

pelagic <- pelagic %>% select(Haul.Join,Year,NMFS.Area,Duration..Min.,Lat.DD.End,Lon.DD.End,Species.Name,Sample.Number:Extrapolated.Weight..kg.)
```

Extract salmon shark hauls.
```{r}
salmon_shark <- pelagic %>% filter(Species.Name == "SALMON SHARK")

ss_hauls <- salmon_shark %>% select(Haul.Join) %>% distinct() %>% pull()
```

Pad with pelagic trawl hauls that did not catch any salmon shark. These will be zeroes in the data.
```{r}
all_hauls <- pelagic %>% select(Haul.Join) %>% distinct() %>% pull()
empty_hauls <- setdiff(all_hauls,ss_hauls)

zero_catches <- pelagic %>% filter(Haul.Join %in% empty_hauls) %>%
  select(Haul.Join:Lon.DD.End) %>% 
  distinct() %>%
  mutate(Species.Name='SALMON SHARK',Sample.Number=0,Sample.Weight..kg.=0,Extrapolated.Number=0,Extrapolated.Weight..kg.=0)

salmon_shark <- salmon_shark %>% rbind(zero_catches)
```

Work out some form of CPUE. All we have to go off is the duration of the haul in minutes. This is problematic because the gear may differ between vessels, meaning that the same haul duration may yield very different CPUE. Also bear in mind that this is a by-catch species.
```{r}
salmon_shark <- salmon_shark %>% mutate(CPUE_num = Extrapolated.Number/Duration..Min.,
                                        CPUE_weight = Extrapolated.Weight..kg./Duration..Min.)
```

It is possible that somewhere else online (e.g. are the observer data only available on AKFIN or can they be pulled from somewhere else? What is NORPAC's 'official' download channel?) there is a haul information data set, that provides more info on the gear and the tow specifications?

Visualise in space.
```{r}
ss_sf <- salmon_shark %>% st_as_sf(coords = c(x = 'Lon.DD.End', y='Lat.DD.End'), crs=4326)

ss_bbox <- ss_sf %>% st_bbox()

coast <- maps::map("worldHires", c("USA","Canada"), plot = FALSE, fill = TRUE)
coast_sf <- coast %>% st_as_sf() #%>% st_transform(crs = atlantis_crs)

# pick a year and view the data for that year
ss_sf %>% filter(CPUE_weight>0) %>%
  ggplot()+
  geom_sf(aes(color=log1p(CPUE_weight)))+
  geom_sf(data = coast_sf)+
  coord_sf(xlim = c(obs_bbox$xmin,obs_bbox$xmax), ylim = c(obs_bbox$ymin,obs_bbox$ymax))+
  scale_color_viridis()+
  theme_minimal()+
  #facet_wrap(~Year)+
  labs(title = paste('Hauls from Observer data for',ss_sf$Species.Name[1],sep = ' '))
```
Probably not much data to extrapolate on for sdmTMB. They are present in about 5% the pelagic trawl hauls. They are also highly mobile, so an SDM approach is probably not meaningful. However, we do need something to go off. Try and fit sdmTMB and see what sort of model we get out of it. We may still pick up coarse cross-shelf distributions. Compare this with tagging data, also worth looking into the IPHC data for potential longline by-catch.

Write out the data.
```{r}
saveRDS(ss_sf, '../data/Fishery/salmon_shark.RDS')
```

